@model IEnumerable<eduMentor.Models.Curso>
@{
    ViewData["Title"] = "Mis Cursos";
}

<style>
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
    }

    .curso-card {
        transition: transform 0.3s, box-shadow 0.3s;
        cursor: pointer;
        height: 100%;
        border: none;
        border-radius: 15px;
        overflow: hidden;
    }

        .curso-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

    .curso-card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border: none;
    }

    .curso-card-body {
        padding: 1.5rem;
    }

    .badge-nivel {
        font-size: 0.85rem;
        padding: 0.5em 1em;
        border-radius: 20px;
    }

    .nivel-Principiante {
        background: #28a745;
        color: white;
    }

    .nivel-Intermedio {
        background: #ffc107;
        color: #000;
    }

    .nivel-Avanzado {
        background: #dc3545;
        color: white;
    }

    .badge-estado {
        font-size: 0.85rem;
        padding: 0.5em 1em;
        border-radius: 20px;
    }

    .curso-stats {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 10px;
        margin-top: 1rem;
    }

    .stat-item {
        text-align: center;
    }

    .stat-number {
        font-size: 1.5rem;
        font-weight: bold;
        color: #667eea;
    }

    .stat-label {
        font-size: 0.85rem;
        color: #6c757d;
    }

    .curso-actions {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
    }

    .btn-action-card {
        width: 35px;
        height: 35px;
        padding: 0;
        border-radius: 50%;
        margin-left: 5px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }

        .empty-state i {
            font-size: 5rem;
            color: #dee2e6;
        }
</style>

<div class="container-fluid">
    <!-- Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-2"><i class="bi bi-book-half"></i> Mis Cursos</h1>
                @if (ViewBag.EsInstructor)
                {
                    <p class="mb-0">Bienvenido, <strong>@ViewBag.NombreInstructor</strong>. Administra tus cursos.</p>
                }
                else
                {
                    <p class="mb-0">Bienvenido, <strong>@ViewBag.NombreInstructor</strong>. Estos son tus cursos inscritos.</p>
                }
            </div>

            @if (ViewBag.EsInstructor)
            {
                <button type="button" class="btn btn-light btn-lg" data-bs-toggle="modal" data-bs-target="#createCursoModal">
                    <i class="bi bi-plus-circle"></i> Crear Nuevo Curso
                </button>
            }
        </div>
    </div>


    <!-- Filtros y búsqueda -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-5">
                    <input type="text" id="searchInput" class="form-control" placeholder="🔍 Buscar curso por título o descripción...">
                </div>
                <div class="col-md-3">
                    <select id="nivelFilter" class="form-select">
                        <option value="">Todos los niveles</option>
                        <option value="Principiante">Principiante</option>
                        <option value="Intermedio">Intermedio</option>
                        <option value="Avanzado">Avanzado</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select id="estadoFilter" class="form-select">
                        <option value="">Todos</option>
                        <option value="true">Activos</option>
                        <option value="false">Inactivos</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-secondary w-100" onclick="clearFilters()">
                        <i class="bi bi-x-circle"></i> Limpiar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Grid de Tarjetas de Cursos -->
    <div class="row" id="cursosContainer">
        @if (Model != null && Model.Any())
        {
            @foreach (var curso in Model)
            {
                <div class="col-xl-4 col-lg-6 col-md-6 mb-4 curso-item"
                     data-titulo="@curso.Titulo.ToLower()"
                     data-descripcion="@(curso.Descripcion?.ToLower())"
                     data-nivel="@curso.Nivel"
                     data-estado="@curso.Estado.ToString().ToLower()">

                    <div class="card curso-card shadow-sm">
                        <!-- Botones de acción flotantes -->
                        <div class="curso-actions">
                            @if (ViewBag.EsInstructor)
                            {
                                <button type="button" class="btn btn-warning btn-action-card text-white"
                                        onclick="event.stopPropagation(); openEditModal(@curso.IdCurso);"
                                        title="Editar curso">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-danger btn-action-card"
                                        onclick="event.stopPropagation(); confirmDelete(@curso.IdCurso, '@Html.Raw(curso.Titulo)');"
                                        title="Eliminar curso">
                                    <i class="bi bi-trash"></i>
                                </button>
                            }
                        </div>


                        <!-- Header de la tarjeta (clickeable para ir a módulos) -->
                        <div class="curso-card-header" onclick="window.location.href='/Moduloes/Index?idCurso=@curso.IdCurso'">
                            <h5 class="mb-1">@curso.Titulo</h5>
                            <small><i class="bi bi-calendar"></i> Creado: @curso.FechaCreacion.ToString("dd/MM/yyyy")</small>
                        </div>

                        <!-- Cuerpo de la tarjeta (clickeable) -->
                        <div class="curso-card-body" onclick="window.location.href='/Moduloes/Index?idCurso=@curso.IdCurso'">
                            <p class="text-muted mb-3">
                                @if (!string.IsNullOrEmpty(curso.Descripcion))
                                {
                                    @(curso.Descripcion.Length > 120 ? curso.Descripcion.Substring(0, 120) + "..." : curso.Descripcion)
                                }
                                else
                                {
                                    <em>Sin descripción</em>
                                }
                            </p>

                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="badge-nivel nivel-@curso.Nivel">
                                    <i class="bi bi-bar-chart"></i> @curso.Nivel
                                </span>
                                @if (curso.Estado)
                                {
                                    <span class="badge bg-success badge-estado">
                                        <i class="bi bi-check-circle"></i> Activo
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary badge-estado">
                                        <i class="bi bi-pause-circle"></i> Inactivo
                                    </span>
                                }
                            </div>

                            <!-- Estadísticas del curso -->
                            <div class="curso-stats">
                                <div class="row">
                                    <div class="col-6 stat-item">
                                        <div class="stat-number" id="modulos-count-@curso.IdCurso">-</div>
                                        <div class="stat-label">Módulos</div>
                                    </div>
                                    <div class="col-6 stat-item">
                                        <div class="stat-number" id="duracion-total-@curso.IdCurso">-</div>
                                        <div class="stat-label">Min. Total</div>
                                    </div>
                                </div>
                            </div>

                            <div class="text-center mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-arrow-right-circle"></i> Click para ver módulos
                                </small>
                            </div>
                            @if (ViewBag.EsEstudiante)
                            {
                                <div class="text-center mt-3">
                                    <button class="btn btn-success btn-sm"
                                            data-bs-toggle="modal"
                                            data-bs-target="#confirmCertModal-@curso.IdCurso"
                                            id="btnCert-@curso.IdCurso"
                                            style="display:none;">
                                        🎓 Generar Certificado
                                    </button>
                                </div>

                                <!-- Modal -->
                                <div class="modal fade" id="confirmCertModal-@curso.IdCurso" tabindex="-1">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content">
                                            <div class="modal-header bg-success text-white">
                                                <h5 class="modal-title"><i class="bi bi-award"></i> Confirmar Generación</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body text-center">
                                                <p>¿Deseas generar tu certificado del curso <strong>@curso.Titulo</strong>?</p>
                                                <p class="text-muted">Se registrará automáticamente la fecha de hoy.</p>
                                            </div>
                                            <div class="modal-footer justify-content-center">
                                                <a href="/Certificadoes/Create?idCurso=@curso.IdCurso" class="btn btn-success">
                                                    Sí, generar
                                                </a>
                                                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <script>
                    // Cargar estadísticas del curso via AJAX
                    fetch('/Cursos/GetCursoStats/@curso.IdCurso')
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('modulos-count-@curso.IdCurso').textContent = data.totalModulos;
                            document.getElementById('duracion-total-@curso.IdCurso').textContent = data.duracionTotal;
                        })
                        .catch(error => {
                            console.error('Error loading stats:', error);
                            document.getElementById('modulos-count-@curso.IdCurso').textContent = '0';
                            document.getElementById('duracion-total-@curso.IdCurso').textContent = '0';
                        });
                </script>
            }
        }
        else
        {
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body empty-state">
                        <i class="bi bi-inbox"></i>
                        @if (ViewBag.EsInstructor)
                        {
                            <h3 class="mt-3">No tienes cursos creados</h3>
                            <p class="text-muted">Comienza creando tu primer curso haciendo click en "Crear Nuevo Curso"</p>
                            <button type="button" class="btn btn-primary btn-lg mt-3" data-bs-toggle="modal" data-bs-target="#createCursoModal">
                                <i class="bi bi-plus-circle"></i> Crear Mi Primer Curso
                            </button>
                        }
                        else
                        {
                            <h3 class="mt-3">Aún no estás inscrito en ningún curso</h3>
                            <p class="text-muted">Explora el catálogo de cursos y comienza a aprender.</p>
                            <a href="/Inscripcions" class="btn btn-primary btn-lg mt-3">
                                <i class="bi bi-search"></i> Ver Catálogo
                            </a>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>
@if (ViewBag.EsInstructor)
{
    @await Html.PartialAsync("~/Views/Pwa/Cursos/_CreateCursoModal.cshtml", new eduMentor.Models.Curso())
    @await Html.PartialAsync("~/Views/Pwa/Cursos/_EditCursoModal.cshtml", new eduMentor.Models.Curso())
}



@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // Función para abrir modal de edición
        function openEditModal(id) {
            fetch('/Cursos/GetCurso/' + id)
                .then(response => response.json())
                .then(data => {
                    // Configurar la acción del formulario con el ID correcto
                    document.getElementById('editCursoForm').action = '/Cursos/Edit/' + data.idCurso;

                    // Poblar los campos del formulario
                    document.getElementById('editIdCurso').value = data.idCurso;
                    document.getElementById('editIdInstructor').value = data.idInstructor;
                    document.getElementById('editTitulo').value = data.titulo;
                    document.getElementById('editDescripcion').value = data.descripcion || '';
                    document.getElementById('editNivel').value = data.nivel;
                    document.getElementById('estadoEditSwitch').checked = data.estado;
                    document.getElementById('editFechaCreacion').value = data.fechaCreacion;
                    document.getElementById('editInfoFechaCreacion').textContent = new Date(data.fechaCreacion).toLocaleDateString('es-GT');

                    new bootstrap.Modal(document.getElementById('editCursoModal')).show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al cargar los datos del curso');
                });
        }

        // Confirmación de eliminación
        function confirmDelete(id, titulo) {
            if (confirm('¿Estás seguro de que deseas eliminar el curso "' + titulo + '"?\n\nEsta acción eliminará también todos los módulos y contenido asociado. No se puede deshacer.')) {
                var form = document.createElement('form');
                form.method = 'POST';
                form.action = '/Cursos/Delete/' + id;

                var token = document.querySelector('input[name="__RequestVerificationToken"]');
                if (token) {
                    var hiddenToken = document.createElement('input');
                    hiddenToken.type = 'hidden';
                    hiddenToken.name = '__RequestVerificationToken';
                    hiddenToken.value = token.value;
                    form.appendChild(hiddenToken);
                }

                document.body.appendChild(form);
                form.submit();
            }
        }

        // Búsqueda y filtros
        document.getElementById('searchInput').addEventListener('keyup', filterCursos);
        document.getElementById('nivelFilter').addEventListener('change', filterCursos);
        document.getElementById('estadoFilter').addEventListener('change', filterCursos);

        function filterCursos() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const nivelFilter = document.getElementById('nivelFilter').value;
            const estadoFilter = document.getElementById('estadoFilter').value;
            const cursos = document.querySelectorAll('.curso-item');

            cursos.forEach(curso => {
                const titulo = curso.dataset.titulo || '';
                const descripcion = curso.dataset.descripcion || '';
                const nivel = curso.dataset.nivel;
                const estado = curso.dataset.estado;

                const matchSearch = titulo.includes(searchTerm) || descripcion.includes(searchTerm);
                const matchNivel = !nivelFilter || nivel === nivelFilter;
                const matchEstado = !estadoFilter || estado === estadoFilter;

                if (matchSearch && matchNivel && matchEstado) {
                    curso.style.display = '';
                } else {
                    curso.style.display = 'none';
                }
            });
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('nivelFilter').value = '';
            document.getElementById('estadoFilter').value = '';
            filterCursos();
        }

        // Mensajes de éxito/error
        @if (TempData["Success"] != null)
        {
                <text>
                window.addEventListener('load', function() {
                    var createModal = bootstrap.Modal.getInstance(document.getElementById('createCursoModal'));
                    var editModal = bootstrap.Modal.getInstance(document.getElementById('editCursoModal'));
                    if (createModal) createModal.hide();
                    if (editModal) editModal.hide();

                    // Mostrar toast o alerta
                    alert('@TempData["Success"]');
                });
                </text>
        }

        @if (TempData["Error"] != null)
        {
                <text>
                window.addEventListener('load', function() {
                    alert('@TempData["Error"]');
                });
                </text>
        }

        document.addEventListener("DOMContentLoaded", () => {
            fetch('/api/Progreso/CursoCompletado') 
           
        });
    </script>
}
