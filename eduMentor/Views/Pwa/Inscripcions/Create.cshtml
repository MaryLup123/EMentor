@model IEnumerable<eduMentor.Models.Curso>
@{
    ViewData["Title"] = "Catálogo de Cursos";
    var cursosInscritos = ViewBag.CursosInscritos as List<int> ?? new List<int>();
}

<style>
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
    }

    .curso-card {
        transition: transform 0.3s, box-shadow 0.3s;
        cursor: pointer;
        height: 100%;
        border: none;
        border-radius: 15px;
        overflow: hidden;
        position: relative;
    }

        .curso-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        .curso-card.inscrito {
            opacity: 0.7;
            border: 3px solid #28a745;
        }

    .curso-card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border: none;
    }

    .curso-card-body {
        padding: 1.5rem;
    }

    .badge-nivel {
        font-size: 0.85rem;
        padding: 0.5em 1em;
        border-radius: 20px;
    }

    .nivel-Principiante {
        background: #28a745;
        color: white;
    }

    .nivel-Intermedio {
        background: #ffc107;
        color: #000;
    }

    .nivel-Avanzado {
        background: #dc3545;
        color: white;
    }

    .curso-stats {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 10px;
        margin-top: 1rem;
    }

    .stat-item {
        text-align: center;
    }

    .stat-number {
        font-size: 1.3rem;
        font-weight: bold;
        color: #667eea;
    }

    .stat-label {
        font-size: 0.85rem;
        color: #6c757d;
    }

    .badge-inscrito {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
        font-size: 0.9rem;
        padding: 0.5em 1em;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }

        .empty-state i {
            font-size: 5rem;
            color: #dee2e6;
        }
</style>

<div class="container-fluid">
    <!-- Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-2"><i class="bi bi-mortarboard"></i> Catálogo de Cursos</h1>
                <p class="mb-0">Explora y matricúlate en los cursos disponibles</p>
            </div>
            <a href="/Pwa/Index" class="btn btn-light btn-lg">
                <i class="bi bi-house"></i> Volver al Inicio
            </a>
        </div>
    </div>

    <!-- Filtros y búsqueda -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <input type="text" id="searchInput" class="form-control" placeholder="🔍 Buscar curso por título o descripción...">
                </div>
                <div class="col-md-3">
                    <select id="nivelFilter" class="form-select">
                        <option value="">Todos los niveles</option>
                        <option value="Principiante">Principiante</option>
                        <option value="Intermedio">Intermedio</option>
                        <option value="Avanzado">Avanzado</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-secondary w-100" onclick="clearFilters()">
                        <i class="bi bi-x-circle"></i> Limpiar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Grid de Tarjetas de Cursos -->
    <div class="row" id="cursosContainer">
        @if (Model != null && Model.Any())
        {
            @foreach (var curso in Model)
            {
                var yaInscrito = cursosInscritos.Contains(curso.IdCurso);
                var cardClass = yaInscrito ? "curso-card inscrito" : "curso-card";

                <div class="col-xl-4 col-lg-6 col-md-6 mb-4 curso-item"
                     data-titulo="@curso.Titulo.ToLower()"
                     data-descripcion="@(curso.Descripcion?.ToLower())"
                     data-nivel="@curso.Nivel">

                    <div class="card @cardClass shadow-sm" onclick="abrirModalInscripcion(@curso.IdCurso, '@Html.Raw(curso.Titulo)', @yaInscrito.ToString().ToLower())">

                        @if (yaInscrito)
                        {
                            <span class="badge bg-success badge-inscrito">
                                <i class="bi bi-check-circle-fill"></i> Ya inscrito
                            </span>
                        }

                        <!-- Header de la tarjeta -->
                        <div class="curso-card-header">
                            <h5 class="mb-1">@curso.Titulo</h5>
                            <small>
                                <i class="bi bi-person"></i> @(curso.Instructor?.Nombre ?? "Instructor")
                            </small>
                        </div>

                        <!-- Cuerpo de la tarjeta -->
                        <div class="curso-card-body">
                            <p class="text-muted mb-3">
                                @if (!string.IsNullOrEmpty(curso.Descripcion))
                                {
                                    @(curso.Descripcion.Length > 120 ? curso.Descripcion.Substring(0, 120) + "..." : curso.Descripcion)
                                }
                                else
                                {
                                    <em>Sin descripción</em>
                                }
                            </p>

                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="badge-nivel nivel-@curso.Nivel">
                                    <i class="bi bi-bar-chart"></i> @curso.Nivel
                                </span>
                                <small class="text-muted">
                                    <i class="bi bi-calendar"></i> @curso.FechaCreacion.ToString("dd/MM/yyyy")
                                </small>
                            </div>

                            <!-- Estadísticas del curso -->
                            <div class="curso-stats">
                                <div class="row">
                                    <div class="col-4 stat-item">
                                        <div class="stat-number" id="modulos-@curso.IdCurso">-</div>
                                        <div class="stat-label">Módulos</div>
                                    </div>
                                    <div class="col-4 stat-item">
                                        <div class="stat-number" id="duracion-@curso.IdCurso">-</div>
                                        <div class="stat-label">Min.</div>
                                    </div>
                                    <div class="col-4 stat-item">
                                        <div class="stat-number" id="inscritos-@curso.IdCurso">-</div>
                                        <div class="stat-label">Alumnos</div>
                                    </div>
                                </div>
                            </div>

                            <div class="text-center mt-3">
                                @if (yaInscrito)
                                {
                                    <small class="text-success">
                                        <i class="bi bi-check-circle"></i> ¡Ya estás inscrito en este curso!
                                    </small>
                                }
                                else
                                {
                                    <small class="text-primary">
                                        <i class="bi bi-hand-index"></i> Click para inscribirte
                                    </small>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <script>
                    // Cargar estadísticas del curso
                    fetch('/Inscripcions/GetCursoStats?id=@curso.IdCurso')
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('modulos-@curso.IdCurso').textContent = data.totalModulos;
                            document.getElementById('duracion-@curso.IdCurso').textContent = data.duracionTotal;
                            document.getElementById('inscritos-@curso.IdCurso').textContent = data.totalInscritos;
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            document.getElementById('modulos-@curso.IdCurso').textContent = '0';
                            document.getElementById('duracion-@curso.IdCurso').textContent = '0';
                            document.getElementById('inscritos-@curso.IdCurso').textContent = '0';
                        });
                </script>
            }
        }
        else
        {
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body empty-state">
                        <i class="bi bi-inbox"></i>
                        <h3 class="mt-3">No hay cursos disponibles</h3>
                        <p class="text-muted">Por el momento no hay cursos activos para inscripción</p>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- Modal de Inscripción -->
<div class="modal fade" id="modalInscripcion" tabindex="-1" aria-labelledby="modalInscripcionLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title" id="modalInscripcionLabel">
                    <i class="bi bi-mortarboard-fill"></i> Confirmar Inscripción
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form asp-action="Inscribirse" asp-controller="Inscripcions" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="idCurso" id="modalIdCurso" />

                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="bi bi-mortarboard" style="font-size: 3rem; color: #667eea;"></i>
                    </div>

                    <h5 class="text-center mb-3" id="modalTituloCurso"></h5>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>¿Estás seguro?</strong>
                        <p class="mb-0 mt-2">
                            Te vas a inscribir en este curso y tendrás acceso a todo su contenido.
                        </p>
                    </div>

                    <div class="alert alert-success" id="alertYaInscrito" style="display:none;">
                        <i class="bi bi-check-circle"></i>
                        <strong>Ya estás inscrito</strong>
                        <p class="mb-0 mt-2">
                            Ya tienes acceso a este curso.
                        </p>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary" id="btnConfirmarInscripcion">
                        <i class="bi bi-check-circle"></i> Confirmar Inscripción
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function abrirModalInscripcion(idCurso, titulo, yaInscrito) {
            document.getElementById('modalIdCurso').value = idCurso;
            document.getElementById('modalTituloCurso').textContent = titulo;

            if (yaInscrito) {
                document.getElementById('alertYaInscrito').style.display = 'block';
                document.getElementById('btnConfirmarInscripcion').style.display = 'none';
            } else {
                document.getElementById('alertYaInscrito').style.display = 'none';
                document.getElementById('btnConfirmarInscripcion').style.display = 'inline-block';
            }

            var modal = new bootstrap.Modal(document.getElementById('modalInscripcion'));
            modal.show();
        }

        // Filtros
        document.getElementById('searchInput').addEventListener('keyup', filterCursos);
        document.getElementById('nivelFilter').addEventListener('change', filterCursos);

        function filterCursos() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const nivelFilter = document.getElementById('nivelFilter').value;
            const cursos = document.querySelectorAll('.curso-item');

            cursos.forEach(curso => {
                const titulo = curso.dataset.titulo || '';
                const descripcion = curso.dataset.descripcion || '';
                const nivel = curso.dataset.nivel;

                const matchSearch = titulo.includes(searchTerm) || descripcion.includes(searchTerm);
                const matchNivel = !nivelFilter || nivel === nivelFilter;

                if (matchSearch && matchNivel) {
                    curso.style.display = '';
                } else {
                    curso.style.display = 'none';
                }
            });
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('nivelFilter').value = '';
            filterCursos();
        }

        // Mensajes
        @if (TempData["Success"] != null)
        {
                    <text>
                    window.addEventListener('load', function() {
                        alert('@TempData["Success"]');
                    });
                    </text>
        }

        @if (TempData["Error"] != null)
        {
                    <text>
                    window.addEventListener('load', function() {
                        alert('@TempData["Error"]');
                    });
                    </text>
        }
    </script>
}