@model eduMentor.Models.Contenido
@{
    var isEdit = (Model?.IdContenido ?? 0) > 0;
    string tituloVista = isEdit ? "Editar Tarea / Formulario" : "Crear Tarea / Formulario";
    string accion = isEdit ? "Edit" : "Create";
    string botonTexto = isEdit ? "Guardar Cambios" : "Guardar Tarea";
}


<style>
    .page-header {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
    }
</style>

<div class="container-fluid mt-4">
    <!-- Encabezado -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-2"><i class="bi bi-ui-checks"></i> @tituloVista</h1>
                <p class="mb-0">Crea o edita preguntas personalizadas para tus estudiantes</p>
            </div>
            <a href="/Contenidos/Index?idModulo=@ViewBag.IdModulo" class="btn btn-light btn-lg">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    <!-- Formulario -->
    <form asp-action="@accion" asp-controller="Contenidos" method="post" id="createTareaForm" onsubmit="return prepararTareaJSON()">
        @Html.AntiForgeryToken()

        <!-- Campos ocultos -->
        <input type="hidden" name="IdContenido" value="@Model.IdContenido" />
        <input type="hidden" name="IdModulo" id="tareaIdModulo" value="@ViewBag.IdModulo" />
        <input type="hidden" name="Tipo" value="Tarea" />
        <input type="hidden" name="EsTarea" value="true" />
        <input type="hidden" name="FechaCreacion" value="@Model.FechaCreacion.ToString("o")" />
        <input type="hidden" id="tareaJsonContenido" name="JsonContenido" value="@Model.JsonContenido" />

        <!-- Información básica -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Información de la Tarea</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-8">
                        <label class="form-label fw-bold"><i class="bi bi-text-left"></i> Título *</label>
                        <input name="Titulo" id="tareaTitulo" class="form-control"
                               value="@Model.Titulo" placeholder="Ej: Evaluación del módulo 1" required />
                    </div>

                    <div class="col-md-2">
                        <label class="form-label fw-bold"><i class="bi bi-list-ol"></i> Orden *</label>
                        <input name="Orden" id="tareaOrden" type="number" class="form-control" min="1"
                               value="@(Model.Orden == 0 ? 1 : Model.Orden)" required />
                    </div>

                    <div class="col-md-2">
                        <label class="form-label fw-bold"><i class="bi bi-star"></i> Peso *</label>
                        <input name="Peso" id="tareaPeso" type="number" step="0.1" class="form-control" min="0.1"
                               value="@(Model.Peso == 0 ? 1.0 : Model.Peso)" required />
                    </div>

                    <div class="col-12">
                        <label class="form-label fw-bold"><i class="bi bi-card-text"></i> Instrucciones</label>
                        <textarea id="tareaDescripcion" class="form-control" rows="3"
                                  placeholder="Indica a los estudiantes qué deben hacer..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Constructor de preguntas -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-question-circle"></i> Preguntas</h5>
                <button type="button" class="btn btn-light btn-sm" onclick="agregarPregunta()">
                    <i class="bi bi-plus-circle"></i> Agregar Pregunta
                </button>
            </div>
            <div class="card-body" id="preguntasContainer">
                <div class="alert alert-info text-center mb-0">
                    <i class="bi bi-info-circle"></i> No hay preguntas todavía. Haz clic en "Agregar Pregunta" para comenzar.
                </div>
            </div>
        </div>

        <!-- Botones -->
        <div class="text-center mb-5">
            <button type="button" class="btn btn-secondary btn-lg me-2" onclick="window.history.back()">
                <i class="bi bi-x-circle"></i> Cancelar
            </button>
            <button type="submit" class="btn btn-success btn-lg">
                <i class="bi bi-check-circle"></i> @botonTexto
            </button>
        </div>
    </form>
</div>

<script>
    let contadorPreguntas = 0;

    // ✅ Precargar preguntas si estamos editando
    document.addEventListener("DOMContentLoaded", () => {
        const jsonRaw = document.getElementById('tareaJsonContenido').value;
        if (jsonRaw) {
            try {
                const data = JSON.parse(jsonRaw);
                document.getElementById("tareaDescripcion").value = data.descripcion ?? "";

                if (data.preguntas) {
                    data.preguntas.forEach(p => {
                        agregarPregunta();
                        const card = document.querySelector(`#pregunta-${contadorPreguntas}`);
                        card.querySelector('input[name="texto"]').value = p.texto;
                        card.querySelector('select[name="tipo"]').value = p.tipo;
                        if (p.tipo === 'opcion') {
                            cambiarTipo(contadorPreguntas, 'opcion');
                            p.opciones?.forEach(o => {
                                const lista = card.querySelector(`#listaOpciones-${contadorPreguntas}`);
                                const li = document.createElement('li');
                                li.className = "list-group-item d-flex justify-content-between align-items-center";
                                li.innerHTML = `<span>${o}</span><button class="btn btn-sm btn-outline-danger"><i class="bi bi-x"></i></button>`;
                                li.querySelector('button').onclick = () => li.remove();
                                lista.appendChild(li);
                            });
                        } else if (p.tipo === 'verdaderoFalso') {
                            cambiarTipo(contadorPreguntas, 'verdaderoFalso');
                        }
                        card.querySelector('input[type="checkbox"]').checked = p.requerida ?? true;
                    });
                }
            } catch (err) {
                console.warn("⚠️ Error al parsear JSON existente:", err);
            }
        }
    });

    function agregarPregunta() {
        contadorPreguntas++;
        const contenedor = document.getElementById('preguntasContainer');
        if (contadorPreguntas === 1) contenedor.innerHTML = '';

        const preguntaDiv = document.createElement('div');
        preguntaDiv.className = 'card border-primary mb-3';
        preguntaDiv.id = `pregunta-${contadorPreguntas}`;

        preguntaDiv.innerHTML = `
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-patch-question"></i> Pregunta ${contadorPreguntas}</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="eliminarPregunta(${contadorPreguntas})">
                    <i class="bi bi-trash"></i> Eliminar
                </button>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Texto *</label>
                    <input type="text" class="form-control" name="texto" placeholder="Ej: ¿Cuál es tu nombre?" required />
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Tipo</label>
                    <select class="form-select" name="tipo" onchange="cambiarTipo(${contadorPreguntas}, this.value)">
                        <option value="texto">📝 Respuesta abierta</option>
                        <option value="opcion">☑️ Opción múltiple</option>
                        <option value="verdaderoFalso">✓✗ Verdadero/Falso</option>
                    </select>
                </div>
                <div id="opciones-${contadorPreguntas}" style="display:none;">
                    <label class="form-label fw-bold">Opciones</label>
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" placeholder="Escribe una opción"
                               id="inputOpcion-${contadorPreguntas}" />
                        <button class="btn btn-primary" type="button" onclick="agregarOpcion(${contadorPreguntas})">
                            <i class="bi bi-plus"></i> Agregar
                        </button>
                    </div>
                    <ul class="list-group" id="listaOpciones-${contadorPreguntas}"></ul>
                </div>
                <div id="verdaderoFalso-${contadorPreguntas}" style="display:none;">
                    <div class="alert alert-info mb-0">
                        Esta pregunta tendrá dos opciones: <strong>Verdadero</strong> y <strong>Falso</strong>.
                    </div>
                </div>
                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" checked>
                    <label class="form-check-label">Pregunta obligatoria</label>
                </div>
            </div>`;
        contenedor.appendChild(preguntaDiv);
    }

    function eliminarPregunta(id) {
        document.getElementById(`pregunta-${id}`)?.remove();
        const contenedor = document.getElementById('preguntasContainer');
        if (contenedor.children.length === 0) {
            contenedor.innerHTML = `
                <div class="alert alert-info text-center mb-0">
                    <i class="bi bi-info-circle"></i> No hay preguntas todavía. Haz clic en "Agregar Pregunta".
                </div>`;
        }
    }

    function cambiarTipo(id, tipo) {
        document.getElementById(`opciones-${id}`).style.display = tipo === 'opcion' ? 'block' : 'none';
        document.getElementById(`verdaderoFalso-${id}`).style.display = tipo === 'verdaderoFalso' ? 'block' : 'none';
    }

    function agregarOpcion(id) {
        const input = document.getElementById(`inputOpcion-${id}`);
        const lista = document.getElementById(`listaOpciones-${id}`);
        const valor = input.value.trim();
        if (!valor) return alert("Ingresa un texto para la opción");
        const li = document.createElement('li');
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `<span>${valor}</span><button class="btn btn-sm btn-outline-danger"><i class="bi bi-x"></i></button>`;
        li.querySelector('button').onclick = () => li.remove();
        lista.appendChild(li);
        input.value = "";
    }

    function prepararTareaJSON() {
        const idModulo = document.getElementById('tareaIdModulo').value;
        const titulo = document.getElementById('tareaTitulo').value.trim();
        const descripcion = document.getElementById('tareaDescripcion').value.trim();

        if (!titulo) {
            alert("Debe ingresar un título para la tarea.");
            return false;
        }
        if (!idModulo || idModulo === '0') {
            alert("Error: No se pudo obtener el ID del módulo. Recargue la página.");
            return false;
        }

        const preguntas = [];
        document.querySelectorAll('#preguntasContainer .card').forEach(div => {
            const texto = div.querySelector('input[name="texto"]').value.trim();
            const tipo = div.querySelector('select[name="tipo"]').value;
            const requerida = div.querySelector('input[type="checkbox"]').checked;
            if (!texto) return;
            const pregunta = { texto, tipo, requerida };

            if (tipo === 'opcion') {
                pregunta.opciones = [...div.querySelectorAll('ul li span')].map(s => s.textContent.trim());
                if (pregunta.opciones.length < 2) {
                    alert(`La pregunta "${texto}" debe tener al menos 2 opciones.`);
                    return false;
                }
            } else if (tipo === 'verdaderoFalso') {
                pregunta.opciones = ['Verdadero', 'Falso'];
            }

            preguntas.push(pregunta);
        });

        if (preguntas.length === 0) {
            alert("Debe agregar al menos una pregunta.");
            return false;
        }

        const jsonData = {
            tipo: "formulario",
            descripcion,
            preguntas,
            formato: "manual-json",
            version: "1.0"
        };

        document.getElementById('tareaJsonContenido').value = JSON.stringify(jsonData);
        console.log("✅ JSON generado correctamente:", jsonData);
        return true;
    }
</script>
