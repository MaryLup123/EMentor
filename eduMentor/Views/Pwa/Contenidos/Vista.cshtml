@model eduMentor.Models.Contenido
@{
    ViewData["Title"] = "Contenido de Lectura";

    int idEstudiante = ViewBag.IdEstudiante ?? 0;
    bool completado = ViewBag.Completado ?? false;

    string contenidoTexto = "";
    if (!string.IsNullOrEmpty(Model.JsonContenido))
    {
        try
        {
            var data = Newtonsoft.Json.JsonConvert.DeserializeObject<dynamic>(Model.JsonContenido);
            contenidoTexto = data?.contenido != null ? data.contenido.ToString() : "";
        }
        catch
        {
            contenidoTexto = Model.JsonContenido;
        }
    }
}

<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0">
                    <i class="bi bi-journal-text"></i> @Model.Titulo
                </h4>
                <small>Módulo: @ViewBag.TituloModulo</small>
            </div>

            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="switchCompletado"
                       @(completado ? "checked disabled" : "")
                       onchange="marcarCompletado(@Model.IdContenido)" />
                <label class="form-check-label" for="switchCompletado">
                    <i class="bi @(completado ? "bi-check-circle-fill text-warning" : "bi-circle")"></i>
                    @((completado ? "Completado" : "Marcar como completado"))
                </label>
            </div>
        </div>

        <div class="card-body" style="min-height: 300px;">
            @if (!string.IsNullOrEmpty(contenidoTexto))
            {
                if (contenidoTexto.Contains("<") && contenidoTexto.Contains(">"))
                {
                    @Html.Raw(contenidoTexto)
                }
                else
                {
                    <pre style="white-space: pre-wrap; font-family: inherit;">@contenidoTexto</pre>
                }
            }
            else
            {
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> No hay contenido disponible para esta lectura.
                </div>
            }
        </div>

        <div class="card-footer text-end">
            <a href="javascript:history.back()" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Volver al módulo
            </a>
        </div>
    </div>
</div>

@section Scripts {
    @Html.AntiForgeryToken() <!-- agrega el token al DOM -->

    <script>
        function marcarCompletado(idContenido) {
            // Crear el objeto FormData
            const formData = new FormData();
            formData.append("idContenido", idContenido);

            // Buscar el token antiforgery generado en la página
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

            fetch('/ProgresoContenidos/MarcarCompletado', {
                method: 'POST',
                body: formData,
                headers: token ? { 'RequestVerificationToken': token } : {}
            })
            .then(res => {
                if (!res.ok) throw new Error("Error al marcar completado.");
                return res.json();
            })
            .then(data => {
                const input = document.getElementById('switchCompletado');
                const label = document.querySelector('label[for="switchCompletado"]');

                if (data.success) {
                    input.checked = true;
                    input.disabled = true;
                    label.innerHTML = `<i class="bi bi-check-circle-fill text-warning"></i> Completado`;
                } else {
                    alert(data.message);
                    input.checked = true;
                    input.disabled = true;
                    label.innerHTML = `<i class="bi bi-check-circle-fill text-warning"></i> Completado`;
                }
            })
            .catch(err => console.error("❌ Error:", err));
        }
    </script>
}
